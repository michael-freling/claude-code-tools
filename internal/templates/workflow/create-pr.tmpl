You need to create a Pull Request for the current branch. Follow this decision tree to handle the PR creation:

## Context
- Workflow Type: {{.WorkflowType}}
- Branch: {{.Branch}}
- Base Branch: {{.BaseBranch}}
- Description: {{.Description}}

## Metadata Extraction
Before proceeding, analyze the workflow description for GitHub metadata hints. This is OPTIONAL - only extract metadata if clearly indicated:

### Issue References
Look for patterns like:
- "fixes #123", "fix #123"
- "closes #456", "close #456"
- "resolves #789", "resolve #789"
- "related to #101", "relates to #101"
- "addresses #202"

Extract issue numbers and remember them for the PR body.

### Label Hints
Look for patterns like:
- "add bug label", "label: bug"
- "with labels: bug, urgent"
- "label as enhancement"
- "mark as documentation"

Extract label names (lowercase, hyphen-separated).

**Important**: Labels must already exist in the repository before they can be applied. After extracting label hints, you must verify them against the repository's actual labels (see Step 3a).

### Project Hints
Look for patterns like:
- "project: Q1 Planning"
- "add to Roadmap project"
- "include in project Sprint 5"

Extract project names.

**Important**: Be conservative - only extract metadata that is explicitly mentioned. If uncertain, do not extract.

## Decision Tree

### Step 1: Check for commits
First, verify there are commits to create a PR for:
```bash
git log origin/{{.BaseBranch}}..HEAD --oneline
```

If there are NO commits:
- Output a "skipped" status with message "No commits found on branch - nothing to create PR for"
- Do NOT create a PR

### Step 2: Check for existing PR
Check if a PR already exists for this branch:
```bash
gh pr list --head {{.Branch}} --json number,title,state
```

If a PR already exists:
- If state is "OPEN": Output an "exists" status with the PR number
- If state is "CLOSED" or "MERGED": Continue to create a new PR

### Step 3: Push branch to remote
Ensure the branch is pushed to the remote:
```bash
git push -u origin HEAD
```

If push fails due to pre-commit hooks:
- Fix the issues reported by pre-commit
- Stage and commit the fixes
- Retry the push
- If fixes fail after 3 attempts, output "failed" status

### Step 3a: Verify labels (if label hints were extracted)
If you extracted label hints in the Metadata Extraction phase, verify them against the repository's actual labels:

```bash
gh label list --json name
```

Label matching rules:
- Only use labels that exist in the repository
- Match user's label hint to repository labels using case-insensitive partial matching
  - Example: "bug" can match "bug", "Bug", "type: bug", "kind/bug"
  - Example: "enhancement" can match "enhancement", "Enhancement", "type: enhancement"
- If multiple labels match the hint, prefer exact case-insensitive matches first
- If no match is found for a label hint, skip that label (don't fail the PR creation)
- If ambiguous (multiple partial matches and no exact match), skip that label

After matching, keep only the verified labels (exact names from the repository) for use in Step 4.

### Step 4: Create the PR
Create the PR using gh CLI. If metadata was extracted, apply it using the appropriate flags:

Basic PR creation:
```bash
gh pr create --title "<title based on branch/description>" --body "<description>"
```

With labels (if extracted and verified in Step 3a):
```bash
gh pr create --title "<title>" --body "<description>" --label bug --label urgent
```

**Important**: Only use labels that were verified to exist in Step 3a. Use the exact label names from the repository.

With project (if extracted):
```bash
gh pr create --title "<title>" --body "<description>" --project "Roadmap"
```

Combined example with all metadata:
```bash
gh pr create --title "<title>" --body "<description>" --label bug --project "Q1 Planning"
```

PR title guidelines:
- For feature workflows: "feat: <description>"
- For fix workflows: "fix: <description>"
- For refactor workflows: "refactor: <description>"

PR body should include:
- Brief summary of changes
- Reference to the workflow type and description
- Issue keywords at the end (if extracted): "Fixes #123", "Closes #456", "Related to #789"
  - Use "Fixes" or "Closes" for issues that will be closed by this PR
  - Use "Related to" for issues that are related but won't be closed
  - Place these on separate lines at the end of the body

Example PR body with issue references:
```
Brief summary of the changes made in this PR.

Additional context about the implementation.

Fixes #123
Related to #456
```

### Step 5: Verify PR creation
After creating, verify the PR exists and get its number:
```bash
gh pr view --json number
```

## Output Format
Output your result as JSON:
```json
{
  "prNumber": <number or 0 if not created>,
  "status": "<created|exists|skipped|failed>",
  "message": "<explanation of what happened>",
  "metadata": {
    "issues": ["#123", "#456"],
    "labels": ["bug", "enhancement"],
    "projects": ["Roadmap"]
  }
}
```

The `metadata` field is OPTIONAL and should only be included if you extracted and applied metadata:
- `issues`: Array of issue references (with # prefix) that were included in the PR body
- `labels`: Array of label names that were actually applied to the PR (only verified labels from Step 3a)
- `projects`: Array of project names that the PR was added to

If no metadata was extracted or applied, omit the `metadata` field entirely.

**Important for labels**: Only include labels in the metadata output that were:
1. Verified to exist in the repository (Step 3a)
2. Successfully matched from the user's hint to an actual repository label
3. Applied to the PR in the `gh pr create` command

Do not include labels that were hinted but could not be matched or verified.

Example without metadata:
```json
{
  "prNumber": 123,
  "status": "created",
  "message": "PR created successfully"
}
```

Example with partial metadata (only labels):
```json
{
  "prNumber": 123,
  "status": "created",
  "message": "PR created successfully",
  "metadata": {
    "labels": ["bug"]
  }
}
```

### Status values:
- "created": Successfully created a new PR
- "exists": PR already exists for this branch
- "skipped": No commits to create PR for, or PR not needed
- "failed": Failed to create PR after attempts

## Important Notes
- Always check for existing PRs before creating
- Handle pre-commit hook failures gracefully
- Do not force push or use destructive git commands
- If in doubt about creating a PR, output "skipped" status
